UOSP = new Object()

var cacheModule={} // require 관련 변수

function require(src,force){
    if(!force && cacheModule[src]!=undefined){
        return cacheModule[src];
    }
    else{
        var module = {exports:{}}
        var exports=module.exports
        eval(readFile("node_modules/"+src))
        cacheModule[src] = module.exports;
        return module.exports
    }
}

D = require("DBManager.js")
var myDB = android.database.sqlite.SQLiteDatabase.openDatabase("/sdcard/katalkbot/Bots/main/DB", null, android.database.sqlite.SQLiteDatabase.CREATE_IF_NECESSARY);

// ================= 방 관련 변수들 ====================
const console_room_name = "시립봇4 컨트롤방" // 콘솔방 이름
var roomList = ["시립봇4 컨트롤방"]
var roomListNum = roomList.length


UOSP.UOSP1 = function UOSP1(){ // 일반공지 파싱
    let str = ""
    let SW_new = 0; // 새로운 공지가 파싱되었을 경우 1이됨

    let parse = org.jsoup.Jsoup.connect("http://www.uos.ac.kr/korNotice/list.do?list_id=FA1").get().select("ul.listType>li:not(.on)>a").get(0) // 파싱 데이터 (상위공지)
    let title = parse.ownText() // 글 제목
    let adress = parse.attr("onclick").split("'")[3] // 글 주소


    if (title == "" || title == "MIWIFI" || title == undefined) { // 오류일시 종료
        return 0;
    }
    // DB구조 예시: [[공지제목,공지주소],[공지제목],[공지주소]]
    //let DB_num = UOSP.getDB("UOSP1_data").length
    if (UOSP.getDB("title_UOSP1_" + (UOSP.getNum("UOSP1_last") - 1)) != title) { // 새로운 내용이 파싱되었을 경우
        UOSP.setDB("title_UOSP1_" + UOSP.getDB("UOSP1_last"), title) // 새로 파싱된 내용 DB에 기록
        UOSP.setDB("UOSP1_last", UOSP.getNum("UOSP1_last") + 1) // 다음 파싱을 위해 카운트 +1
        SW_new = 1
    }

    if (SW_new == 1) {
        str += "일반 공지가 새로 게시되었습니다\n"
        str += title

        for(let i=0;i<roomListNum;i++){
            UOSP.sendKalingImage(roomList[i],
                "",
                "http://www.uos.ac.kr/korNotice/view.do?list_id=FA1&seq=" + adress
                ,str,"보러가기",0,0)
        }
    }
}

// "http://www.uos.ac.kr/korNotice/view.do?list_id=FA1&seq=7254"
// 일반공지의 첫 공지주소번호는 7254
// DB구조 예시: [[공지제목,공지주소,날짜],[공지제목,공지주소,날짜]]
UOSP.UOSP1_collect = function UOSP1_collect(start_num,stop_num){

    for(let i=start_num;i<stop_num;i++){
        try{
            let body = org.jsoup.Jsoup.connect("http://www.uos.ac.kr/korNotice/view.do?list_id=FA1&seq="+i).get()
            let title = body.select(".listType>li>span").get(0).ownText() // 글 제목
            let date = body.select(".listType>li>ul>li").get(2).ownText() // 글 게시일

            let array = [[title,i,date]]
            let pre_DB = JSON.parse(UOSP.getDB("UOSP1_DB"))
            pre_DB.push(array)
            UOSP.setDB("UOSP1_DB",JSON.stringify(pre_DB))
            if(i%10==0){Api.replyRoom(console_room_name,i+"번 주소까지 진행 완료")}
        }
        catch(e){} // 해당 주소에 아무런 내용이 존재하지 않을 경우 아무것도 하지 않음
    }

}


//====================================== 카링 ======================================



const kalingModule=require("kaling.js").Kakao();

UOSP.kakaoReset = function kakaoReset(){
    Kakao = new kalingModule();
    Kakao.init("29fbf6ec828f27d72544c39a3bb4f8d0"); // P.kakaoint자리
    //Kakao.init("e02397085dc52168fe675d7013e1cfbf"); // P.kakaoint자리

    Kakao.login(UOSP.getDB("kakaoId"), UOSP.getDB("kakaoPw"));
}

UOSP.sendKalingImage = function sendKalingImage(room, imageURL, URL, description,button,width, height){
    var kalingObj={
        "link_ver": "4.0",
        "template_object": {
            "object_type": "feed",
            "content": {
                "title": "",
                "image_url": imageURL,
                "image_width": width||0,
                "image_height": height||0,
                "link": {
                    "web_url": URL,
                    "mobile_web_url": URL
                },
                "description": description || ""
            },
            "buttons": [{
                "title": button || "",
                "link": {
                    "web_url": URL,
                    "mobile_web_url": URL
                }
            }]
        }
    };
    try{
        Kakao.send(room, kalingObj );
    }catch(e){
        UOSP.kakaoReset();
        Kakao.send(room, kalingObj );
    }

}

//========================================= 카링 끝 =========================================



// 테이블 생성 : myDB.execSQL("create table UOSPTable (k text PRIMARY KEY, v text);");

UOSP.setDB = function setDB(key,value){
    if(D.selectForArray("UOSPTable", null, "k like ?", key).length == 0){ // 해당하는 key에 value가 없는 경우
        D.insert("UOSPTable",{k:key, v:value})
    }
    else{ // 해당하는 key에 value가 있는 경우
        D.update("UOSPTable", {v:value}, "k=?", [key])
    }
}

UOSP.getDB = function getDB(key){
    var arr = D.selectForArray("UOSPTable", null, "k=?", [key]);
    if (arr.length > 0) {
        return arr[0][1];
    } else {
        return undefined;
    }
}

UOSP.getNum = function getNum(key) {
    var value = UOSP.getDB(key);
    return isNaN(value) ? 0 : Number(UOSP.getDB(key));
}

module.exports = UOSP