Metro = new Object()

const xmlToJson = (xmlString, i_indent) => org.json.XMLKt.Companion.toJSONObject(xmlString, true).toString(i_indent ? i_indent : 4);
const jsonToXml = (jsonString) => org.json.XMLKt.Companion.toString(jsonString);

var cacheModule={} // require 관련 변수

function require(src,force){
    if(!force && cacheModule[src]!=undefined){
        return cacheModule[src];
    }
    else{
        var module = {exports:{}}
        var exports=module.exports
        eval(readFile("node_modules/"+src))
        cacheModule[src] = module.exports;
        return module.exports
    }
}

D = require("DBManager.js")
var myDB = android.database.sqlite.SQLiteDatabase.openDatabase("/sdcard/katalkbot/Bots/main/DB", null, android.database.sqlite.SQLiteDatabase.CREATE_IF_NECESSARY);





Metro.test = function test(station){

    /*
            "rowNum": "1",
                "selectedCount": "16",
                "totalCount": "16",
                "subwayId": "1001",
                "updnLine": "상행",
                "trainLineNm": "양주행 - 회기방면",
                "subwayHeading": "오른쪽",
                "statnFid": "1001000123",
                "statnTid": "1001000125",
                "statnId": "1001000124",
                "statnNm": "청량리",
                "ordkey": "01001양주0",
                "subwayList": "1001,1063,1067,1075",
                "statnList": "1001000124,1063075117",
                "barvlDt": "0",
                "btrainNo": "0168",
                "bstatnId": "248",
                "bstatnNm": "양주",
                "recptnDt": "2020-07-24 20:39:18.0",
                "arvlMsg2": "전역 도착",
                "arvlMsg3": "제기동",
                "arvlCd": "5"

     */

    let key = "556b6a434572316a35374c6b47524a"

    let body = JSON.parse(xmlToJson(org.jsoup.Jsoup.connect("http://swopenapi.seoul.go.kr/api/subway/"+key+"/xml/realtimeStationArrival/0/30/"+encodeURI(station)).get()))

    let temp = body.realtimeStationArrival.row

    let number = temp.map(v=>v.rowNum) // 출력 번호
    let totalCount = temp.map(v=>v.totalCount)[0] // 출력 번호
    let line_number = temp.map(v=>v.subwayId) // 지하철 노선명
    let updn = temp.map(v=>v.updnLine) // 상하행 구분
    let arrival_msg2 = temp.map(v=>v.arvlMsg2) // 도착정보 : ex> 2역전 혹은 얼마 후 도착인지
    let arrival_msg3 = temp.map(v=>v.arvlMsg3) // 현재위치
    let train_num = temp.map(v=>v.btrainNo) // 열차번호
    let last_station = temp.map(v=>v.bstatnNm) // 종착역

    let stationFid = temp.map(v=>v.statnFid) // 현재위치
    let stationTid = temp.map(v=>v.statnTid) // 열차번호
    let stationId = temp.map(v=>v.statnId) // 종착역

    let array = []

    for (let i=0 ; i<totalCount ; i++){
        array[i] = [number[i],line_number[i],updn[i],train_num[i],arrival_msg2[i],arrival_msg3[i],last_station[i],stationFid[i],stationTid[i],stationId[i]].join("||")
    }

    return array.join("\n\n")

}


Metro.parse = function parse(station){

    let station_name = station.reduceMetro()

    let key = "556b6a434572316a35374c6b47524a"

    let body = JSON.parse(xmlToJson(org.jsoup.Jsoup.connect("http://swopenapi.seoul.go.kr/api/subway/"+key+"/xml/realtimeStationArrival/0/30/"+encodeURI(station_name)).get()))

    let temp = body.realtimeStationArrival.row

    let number = temp.map(v=>v.rowNum) // 출력 번호
    let totalCount = temp.map(v=>v.totalCount)[0] // 출력 번호
    let line_number = temp.map(v=>v.subwayId) // 지하철 노선명
    let updn = temp.map(v=>v.updnLine) // 상하행 구분
    let arrival_msg2 = temp.map(v=>v.arvlMsg2) // 도착정보 : ex> 2역전 혹은 얼마 후 도착인지
    let arrival_msg3 = temp.map(v=>v.arvlMsg3) // 현재위치
    let train_num = temp.map(v=>v.btrainNo) // 열차번호
    let last_station = temp.map(v=>v.bstatnNm) // 종착역

    let stationFid = temp.map(v=>v.statnFid) // 현재위치
    let stationTid = temp.map(v=>v.statnTid) // 열차번호
    let stationId = temp.map(v=>v.statnId) // 종착역

    let pre_array = []
    let array = []

    for (let i=0 ; i<totalCount ; i++){
        pre_array[i] = [[number[i]],[line_number[i]],[updn[i]],[train_num[i]],[arrival_msg2[i]],[arrival_msg3[i]]
            ,[last_station[i]],[stationFid[i]],[stationTid[i]],[stationId[i]],[arrival_msg2[i]]]
    }

    let unique_array = pre_array
    /*
    let unique_array = [pre_array[1]]
    for(let i=1 ; i<pre_array.length ; i++){
        if(unique_array.map(v=>v[3]).indexOf(pre_array[i][3]) < 0) unique_array.push(pre_array[i])
    }

     */

    //pre_array = pre_array.filter(v=>v[6]!=-1)

    array = array.concat( unique_array.filter(v=>String(v[4])==String(station_name+" 도착")) )

    array = array.concat( unique_array.filter(v=>String(v[4])==String(station_name+" 진입")) )

    array = array.concat( unique_array.filter(v=>String(v[4])==String("전역 출발")) )

    array = array.concat( unique_array.filter(v=>String(v[4])==String("전역 도착")) )

    array = array.concat( unique_array.filter(v=>String(v[4])==String("전역 진입")) )

    for (let i=0 ; i<totalCount ; i++){
        try{
            let temp = Number( String(unique_array[i][4]).split("]번째")[0].split("[")[1] ) * 150
            if(isNaN(temp)==false){ unique_array[i][4] = temp }
        }catch(e){}

    }

    for (let i=0 ; i<totalCount ; i++){
        try{
            let temp = Number( String(unique_array[i][4]).split("분")[0] ) * 60
                + Number( String(unique_array[i][4]).split("초")[0].split("분 ")[1] )
            if(isNaN(temp)==false){ unique_array[i][4] = temp }
        }catch(e){}
    }

    unique_array = unique_array.filter(v=>isNaN(v[4])==false)

    array = array.concat( unique_array.sort(function(a,b){return Number(a[4])<Number(b[4]) ? -1 : Number(a[4]) > Number(b[4]) ? 1 : 0}) )

    return array

}

Metro.output = function output(room,station){

    let data = Metro.parse(station)

    if(data.length>5){ data.splice(5,data.length-5) }

    let header_title = station+" 검색 결과"
    let title = []
    let sub_title = []
    for(let i=0 ; i<5 ; i++){
        try{
            title[i] = "현재 위치 : " + data[i][5] + " (" + data[i][6] + "행)"  // 현재 위치 : 선릉 (서울대입구행)
            sub_title[i] = String(data[i][1]).lineNumber() + " " + data[i][2] + " (" + data[i][10] + ")" // 1호선 하행 (5분 4초후)
            THU[i] =
        }
        catch(e){
            title[i] = "-"
            sub_title[i] = "-"
            THU = ""
        }
    }

    let path = ["","","","",""]
    let THU = ["","","","",""]

    Metro.sendKaling_5list(room, header_title, title, sub_title, path, THU)


}



String.prototype.reduceMetro = function(){ // 존나 긴 역명 줄여버리기

    /*
if(station=="이수"||station=="총신대입구"){station = "총신대입구(이수)"}
if(station=="올림픽공원"||station=="한국체대"){station = "올림픽공원(한국체대)"}
if(station=="월드컵경기장"||station=="성산"){station = "월드컵경기장(성산)"}
if(station=="대흥"||station=="서강대앞"){station = "대흥(서강대앞)"}
if(station=="공릉"||station=="서울산업대입구"||station=="서울과기대입구"){station = "공릉(서울산업대입구)"}
if(station=="숭실대입구"||station=="살피재"){station = "숭실대입구(살피재)"}
if(station=="군자"||station=="능동"){station = "군자(능동)"}
if(station=="천호"||station=="풍납토성"){station = "천호(풍납토성)"}
if(station=="굽은다리"||station=="강동구민회관앞"){station = "굽은다리(강동구민회관앞)"}
if(station=="남한산성입구"||station=="성남법원"){station = "남한산성입구(성남법원, 검찰청)"}
if(station=="오목교"||station=="목동운동장앞"){station = "오목교(목동운동장앞)"}
if(station=="몽촌토성"||station=="평화의문"){station = "몽촌토성(평화의문)"}
if(station=="신촌(경의중앙선)"||station=="신촌경의중앙선"){station = "신촌(경의.중앙선)"}
if(station=="증산"||station=="명지대앞"){station = "증산(명지대앞)"}
if(station=="월곡"||station=="동덕여대"){station = "월곡(동덕여대)"}
if(station=="어린이대공원"||station=="세종대"){station = "어린이대공원(세종대)"}
if(station=="상도"||station=="중앙대앞"){station = "상도(중앙대앞)"}
if(station=="신정"||station=="은행정"){station = "신정(은행정)"}
if(station=="광나루"||station=="장신대"){station = "광나루(장신대)"}
if(station=="새절"){station = "새절(신사)"}
if(station=="상월곡"||station=="한국과학기술연구원"){station = "상월곡(한국과학기술연구원)"}
if(station=="화랑대"||station=="서울여대입구"){station = "화랑대(서울여대입구)"}
if(station=="응암순환"||station=="상선"){station = "응암순환(상선)"}
if(station=="쌍용"||station=="나사렛대"){station = "쌍용(나사렛대)"}
if(station=="아차산"||station=="어린이대공원후문"){station = "아차산(어린이대공원후문)"}
if(station=="안암"||station=="고대병원앞"){station = "안암(고대병원앞)"}
 */

    if(this=="올림픽공원(한국체대)"){return "올림픽공원"}
    if(this=="월드컵경기장(성산)"){return "월드컵경기장"}
    if(this=="대흥(서강대앞)"){return "대흥"}
    if(this=="공릉(서울산업대입구)"){return "공릉"}
    if(this=="숭실대입구(살피재)"){return "숭실대입구"}
    if(this=="군자(능동)"){return "군자"}
    if(this=="천호(풍납토성)"){return "천호"}
    if(this=="굽은다리(강동구민회관앞)"){return "굽은다리"}
    if(this=="남한산성입구(성남법원, 검찰청)"){return "남한산성입구"}
    if(this=="오목교(목동운동장앞)"){return "오목교"}
    if(this=="몽촌토성(평화의문)"){return "몽촌토성"}
    if(this=="증산(명지대앞)"){return "증산"}
    if(this=="월곡(동덕여대)"){return "월곡"}
    if(this=="어린이대공원(세종대)"){return "어린이대공원"}
    if(this=="상도(중앙대앞)"){return "상도"}
    if(this=="신정(은행정)"){return "신정"}
    if(this=="광나루(장신대)"){return "광나루"}
    if(this=="새절(신사)"){return "새절"}
    if(this=="상월곡(한국과학기술연구원)"){return "상월곡"}
    if(this=="화랑대(서울여대입구)"){return "화랑대"}
    if(this=="응암순환(상선)"){return "응암순환"}
    if(this=="총신대입구(이수)"){return "이수"}
    if(this=="쌍용(나사렛대)"){return "쌍용"}
    if(this=="아차산(어린이대공원후문)"){return "아차산"}
    if(this=="안암(고대병원앞)"){return "안암"}
    else{return this}
}


String.prototype.lineNumber = function(){ // 존나 긴 역명 줄여버리기

    if(this=="1001"){return "1호선"}
    else if(this=="1002"){return "2호선"}
    else if(this=="1003"){return "3호선"}
    else if(this=="1004"){return "4호선"}
    else if(this=="1005"){return "5호선"}
    else if(this=="1006"){return "6호선"}
    else if(this=="1007"){return "7호선"}
    else if(this=="1008"){return "8호선"}
    else if(this=="1009"){return "9호선"}
    else if(this=="1063"){return "경의중앙선"}
    else if(this=="1075"){return "분당선"}
    else if(this=="1077"){return "신분당선"}
    else if(this=="1065"){return "공항철도"}
    else if(this=="1067"){return "경춘선"}

    else{return this}
}


String.prototype.lineImage = function(){

    if(this=="1001"){return "https://w.namu.la/s/fdd7b559c6991edfb380044a62aa42bcdfafea31b436711ae34ae67a4dc059ed97e56b553b4cd550890881c84236b3f7fee080af1a46e4b92bdabea57ab9ee12d060c2aeca6a6e643c050580989f8dad7ada4fd12731defe63ca062ba93346cd"}
    else if(this=="1002"){return "https://w.namu.la/s/d1f867ce3a4481ed12f642761899015570b43d281dba909012101c23e9183a68827f3e13d2f6eab543f3f6e9f21790ec95de98d56de3bffb2ae9bbaa4e6798da7687bddd3e8acbe3c1f1bb078da2dfffe887aa25edd2912bbcd5625e799b18bc"}
    else if(this=="1003"){return "https://ww.namu.la/s/913f40f9ce357ecb92185f1e66b32dd5bbe1531421fa429d6f9fef7eeac7094b6b644a8be7b852e7e8d43a68b44bd1542aa9b3ec5bd520ffc1b7bf16e4c7be02144c967c247e3dac77eaf70d7058be49153179a6862ae1e98182d9fe81e7d651"}
    else if(this=="1004"){return "https://w.namu.la/s/30e59801fd92b1a476a24c8d98fc3e158216a267e16833ddb123a8c6824d45adb2f3f6d8a161f168430cb9f50b8b32b37a618443893f485039f6e235891ec5a6ae5c03f492b666ea11df4f7d3fbb2cd865c3816cdd9fce72b8847e16307210b7"}
    else if(this=="1005"){return "https://w.namu.la/s/a481f586315e770a8b9e1486d58609929b778a627d18a7099e739dc1b1eb2570dc2954ae7619f65049040fab50be456835bba9f574c092feaa4591c237ab28c88418b0d32fad4899d39273ff363653f163f293647d77f51e7c0cbd18c41fc3fc"}
    else if(this=="1006"){return "https://w.namu.la/s/94d037c40e65f20abb0f665387326de6158daac2d50bacb9371dd0a77846c8ff87c97218cbc0b542ef431b8adda368f95b8c871e84403285e452b27f216d21416cc4a470363df9a4c64793a9edbc5df0dfd03104e60935b4b68b3494a294935a"}
    else if(this=="1007"){return "https://w.namu.la/s/2cc93ae5dac26f4703713e0efa918283221e13ca1cc1bef5d84f7ba3821873351e1e6da1ea54c45b8f4a644d240ee0e8c3a6465c49eee24e24e9611dbb79a3d2ce7065121f058df11588dfb6cb6a28d13e8ce9416f5ab2d7447d7cf16202e52e"}
    else if(this=="1008"){return "https://ww.namu.la/s/14e8ca25bca79a24d788e21a84842c8058cf479a3c4b1194ef7a997dfc586fe5ce8aa996aae601ea9cdacb3c2e3b03c24a0464029be8c298493d84aa407627b902e8a7db40f136ead539867a1409d82f5ea74598a330d5ae777b1c337f4c9a59"}
    else if(this=="1009"){return "https://ww.namu.la/s/ddc488bd113f71587e311903cf726b46c043846b1a7fb4652da81fb4975876f781331faf087a5a8fd484d8da8c697d14b79ddc82a342d9f6de7d18843142dad4205a695a522f126377c9ea2c39810d79ea6597f0cd33f9f50235a5cd7256dc56"}
    else if(this=="1063"){return "https://ww.namu.la/s/eb1edde73b217616e46b1ce36135c9b32d1b6c63332f35a958d6acc1fec74893cf134ee97674dc75cf6258831fa5a591a729b2e33fdc38a61a184fce422b2581e7ebc208e9cf5c66784fcf2b3ccc293a78f2f0f83523df550b91998961300b62"}
    else if(this=="1075"){return "https://w.namu.la/s/00d15eafa3b99c32ab9262b567588ec361d6ab0dd10be7814ac15b944180236e6c35d288d5470d0f923dde0e4e812708d707eee6a19eed57efaa163a275986811c7db9085e7e987b7bb8e76a26d4aee017a7d8fd8bc04ea531316db76738e01f"}
    else if(this=="1077"){return "https://w.namu.la/s/8555d18944d576586f430583d634db3c1b13af1c21601fcccee3fbcde1deed5aabc9d71e25957bc4da20ae0908db27109304997de70cf22cf870e1461c085837c874d8d3df710371621f91d8d3710bb7b7010499079319c21f39760836a14003"}
    else if(this=="1065"){return "https://ww.namu.la/s/12106545ac4d169d72c3c9ad2ce60797a11235f3dffd58347ec578bc4ad90462830bb8b69effbc7a44f4a456146f6e3dbd96ab72141332e97a7e23846374daeadc6dcbe80b191bdce28ae7b042a5d94e7772a8bde8b75600e73691758e9a16d3"}
    else if(this=="1067"){return "https://w.namu.la/s/0483cab3a5b309255b4fe6162b3b4fc56c3139d8b5ec4f5ae2a36e39021f953486003465a2c84a7afd1f986e8ab5e10e5fb1e329e05a3c5ec384ce9f720de915f9485d3044ca39f29c76ceb69d3741582ec9ef38b106426e9fcb715def5d9f57"}

    else{return this}

}


//====================================== 카링 ======================================



const kalingModule=require("kaling.js").Kakao();

Metro.kakaoReset = function kakaoReset(){
    Kakao = new kalingModule();
    //Kakao.init("29fbf6ec828f27d72544c39a3bb4f8d0"); // P.kakaoint자리(이전)
    Kakao.init("904c559bc0ec53c94df6dad990b24c52"); //
    //Kakao.init("e02397085dc52168fe675d7013e1cfbf"); // P.kakaoint자리

    Kakao.login(Metro.getDB("kakaoId"), Metro.getDB("kakaoPw"));
}

Metro.sendKaling_5list = function sendKaling_5list(room, header_title, title, sub_title, path, THU){


    let kalingObj = {
        "link_ver":"4.0",
        "template_id" : (33106),
        "template_args" : {
            header_title : String(header_title),
            title1 : String(title[0]),
            title2 : String(title[1]),
            title3 : String(title[2]),
            title4 : String(title[3]),
            title5 : String(title[4]),
            path1 : String(path[0]),
            path2 : String(path[1]),
            path3 : String(path[2]),
            path4 : String(path[3]),
            path5 : String(path[4]),
            sub_title1 : String(sub_title[0]),
            sub_title2 : String(sub_title[1]),
            sub_title3 : String(sub_title[2]),
            sub_title4 : String(sub_title[3]),
            sub_title5 : String(sub_title[4]),
            THU1 : String(THU[0]),
            THU2 : String(THU[1]),
            THU3 : String(THU[2]),
            THU4 : String(THU[3]),
            THU5 : String(THU[4])
        }
    }
    try{
        Kakao.send(room, kalingObj, "custom");
    }catch(e){
        UOSP.kakaoReset();
        Kakao.send(room, kalingObj, "custom");
    }
}

Metro.sendKaling_4list = function sendKaling_4list(room, header_title, title, sub_title, path, THU){


    let kalingObj = {
        "link_ver":"4.0",
        "template_id" : (33109),
        "template_args" : {
            header_title : String(header_title),
            title1 : String(title[0]),
            title2 : String(title[1]),
            title3 : String(title[2]),
            title4 : String(title[3]),
            path1 : String(path[0]),
            path2 : String(path[1]),
            path3 : String(path[2]),
            path4 : String(path[3]),
            sub_title1 : String(sub_title[0]),
            sub_title2 : String(sub_title[1]),
            sub_title3 : String(sub_title[2]),
            sub_title4 : String(sub_title[3]),
            THU1 : String(THU[0]),
            THU2 : String(THU[1]),
            THU3 : String(THU[2]),
            THU4 : String(THU[3])
        }
    }
    try{
        Kakao.send(room, kalingObj, "custom");
    }catch(e){
        UOSP.kakaoReset();
        Kakao.send(room, kalingObj, "custom");
    }
}

Metro.sendKaling_3list = function sendKaling_3list(room, header_title, title, sub_title, path, THU){


    let kalingObj = {
        "link_ver":"4.0",
        "template_id" : (33111),
        "template_args" : {
            header_title : String(header_title),
            title1 : String(title[0]),
            title2 : String(title[1]),
            title3 : String(title[2]),
            path1 : String(path[0]),
            path2 : String(path[1]),
            path3 : String(path[2]),
            sub_title1 : String(sub_title[0]),
            sub_title2 : String(sub_title[1]),
            sub_title3 : String(sub_title[2]),
            THU1 : String(THU[0]),
            THU2 : String(THU[1]),
            THU3 : String(THU[2])
        }
    }
    try{
        Kakao.send(room, kalingObj, "custom");
    }catch(e){
        UOSP.kakaoReset();
        Kakao.send(room, kalingObj, "custom");
    }
}

Metro.sendKaling_2list = function sendKaling_2list(room, header_title, title, sub_title, path, THU){


    let kalingObj = {
        "link_ver":"4.0",
        "template_id" : (33112),
        "template_args" : {
            header_title : String(header_title),
            title1 : String(title[0]),
            title2 : String(title[1]),
            path1 : String(path[0]),
            path2 : String(path[1]),
            sub_title1 : String(sub_title[0]),
            sub_title2 : String(sub_title[1]),
            THU1 : String(THU[0]),
            THU2 : String(THU[1])
        }
    }
    try{
        Kakao.send(room, kalingObj, "custom");
    }catch(e){
        UOSP.kakaoReset();
        Kakao.send(room, kalingObj, "custom");
    }
}

Metro.sendKaling_1list = function sendKaling_1list(room, header_title, title, sub_title, path, THU){

    let kalingObj = {
        "link_ver":"4.0",
        "template_id" : (33113),
        "template_args" : {
            header_title : String(header_title),
            title1 : String(title[0]),
            path1 : String(path[0]),
            sub_title1 : String(sub_title[0]),
            THU1 : String(THU[0])
        }
    }
    try{
        Kakao.send(room, kalingObj, "custom");
    }catch(e){
        UOSP.kakaoReset();
        Kakao.send(room, kalingObj, "custom");
    }
}

//========================================= 카링 끝 =========================================

// 테이블 생성 : myDB.execSQL("create table UOSPTable (k text PRIMARY KEY, v text);");

Metro.setDB = function setDB(key,value){
    if(D.selectForArray("UOSPTable", null, "k like ?", key).length == 0){ // 해당하는 key에 value가 없는 경우
        D.insert("UOSPTable",{k:key, v:value})
    }
    else{ // 해당하는 key에 value가 있는 경우
        D.update("UOSPTable", {v:value}, "k=?", [key])
    }
}


Metro.getDB = function getDB(key){
    var arr = D.selectForArray("UOSPTable", null, "k=?", [key]);
    if (arr.length > 0) {
        return arr[0][1];
    } else {
        return undefined;
    }
}


Metro.getNum = function getNum(key) {
    var value = UOSP.getDB(key);
    return isNaN(value) ? 0 : Number(UOSP.getDB(key));
}


module.exports = Metro