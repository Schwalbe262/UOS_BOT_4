Metro = new Object()

const xmlToJson = (xmlString, i_indent) => org.json.XMLKt.Companion.toJSONObject(xmlString, true).toString(i_indent ? i_indent : 4);
const jsonToXml = (jsonString) => org.json.XMLKt.Companion.toString(jsonString);

var cacheModule={} // require 관련 변수

function require(src,force){
    if(!force && cacheModule[src]!=undefined){
        return cacheModule[src];
    }
    else{
        var module = {exports:{}}
        var exports=module.exports
        eval(readFile("node_modules/"+src))
        cacheModule[src] = module.exports;
        return module.exports
    }
}

D = require("DBManager.js")
var myDB = android.database.sqlite.SQLiteDatabase.openDatabase("/sdcard/katalkbot/Bots/main/DB", null, android.database.sqlite.SQLiteDatabase.CREATE_IF_NECESSARY);





Metro.test = function test(station){

    /*
            "rowNum": "1",
                "selectedCount": "16",
                "totalCount": "16",
                "subwayId": "1001",
                "updnLine": "상행",
                "trainLineNm": "양주행 - 회기방면",
                "subwayHeading": "오른쪽",
                "statnFid": "1001000123",
                "statnTid": "1001000125",
                "statnId": "1001000124",
                "statnNm": "청량리",
                "ordkey": "01001양주0",
                "subwayList": "1001,1063,1067,1075",
                "statnList": "1001000124,1063075117",
                "barvlDt": "0",
                "btrainNo": "0168",
                "bstatnId": "248",
                "bstatnNm": "양주",
                "recptnDt": "2020-07-24 20:39:18.0",
                "arvlMsg2": "전역 도착",
                "arvlMsg3": "제기동",
                "arvlCd": "5"

     */

    let key = "556b6a434572316a35374c6b47524a"

    let body = JSON.parse(xmlToJson(org.jsoup.Jsoup.connect("http://swopenapi.seoul.go.kr/api/subway/"+key+"/xml/realtimeStationArrival/0/30/"+encodeURI(station)).get()))

    let temp = body.realtimeStationArrival.row

    let number = temp.map(v=>v.rowNum) // 출력 번호
    let totalCount = temp.map(v=>v.totalCount)[0] // 출력 번호
    let line_number = temp.map(v=>v.subwayId) // 지하철 노선명
    let updn = temp.map(v=>v.updnLine) // 상하행 구분
    let arrival_msg2 = temp.map(v=>v.arvlMsg2) // 도착정보 : ex> 2역전 혹은 얼마 후 도착인지
    let arrival_msg3 = temp.map(v=>v.arvlMsg3) // 현재위치
    let train_num = temp.map(v=>v.btrainNo) // 열차번호
    let last_station = temp.map(v=>v.bstatnNm) // 종착역

    let stationFid = temp.map(v=>v.statnFid) // 현재위치
    let stationTid = temp.map(v=>v.statnTid) // 열차번호
    let stationId = temp.map(v=>v.statnId) // 종착역

    let array = []

    for (let i=0 ; i<totalCount ; i++){
        array[i] = [number[i],line_number[i],updn[i],train_num[i],arrival_msg2[i],arrival_msg3[i],last_station[i],stationFid[i],stationTid[i],stationId[i]].join("||")
    }

    return array.join("\n\n")

}


Metro.parse = function parse(station){

    let station_name = station

    let key = "556b6a434572316a35374c6b47524a"

    let body = JSON.parse(xmlToJson(org.jsoup.Jsoup.connect("http://swopenapi.seoul.go.kr/api/subway/"+key+"/xml/realtimeStationArrival/0/30/"+encodeURI(station_name)).get()))

    let temp = body.realtimeStationArrival.row

    let number = temp.map(v=>v.rowNum) // 출력 번호
    let totalCount = temp.map(v=>v.totalCount)[0] // 출력 번호
    let line_number = temp.map(v=>v.subwayId) // 지하철 노선명
    let updn = temp.map(v=>v.updnLine) // 상하행 구분
    let arrival_msg2 = temp.map(v=>v.arvlMsg2) // 도착정보 : ex> 2역전 혹은 얼마 후 도착인지
    let arrival_msg3 = temp.map(v=>v.arvlMsg3) // 현재위치
    let train_num = temp.map(v=>v.btrainNo) // 열차번호
    let last_station = temp.map(v=>v.bstatnNm) // 종착역

    let stationFid = temp.map(v=>v.statnFid) // 현재위치
    let stationTid = temp.map(v=>v.statnTid) // 열차번호
    let stationId = temp.map(v=>v.statnId) // 종착역

    let pre_array = []
    let array = []

    for (let i=0 ; i<totalCount ; i++){
        pre_array[i] = [[number[i]],[line_number[i]],[updn[i]],[train_num[i]],[arrival_msg2[i]],[arrival_msg3[i]]
            ,[last_station[i]],[stationFid[i]],[stationTid[i]],[stationId[i]],[arrival_msg2[i]]]
    }

    let unique_array = pre_array
    /*
    let unique_array = [pre_array[1]]
    for(let i=1 ; i<pre_array.length ; i++){
        if(unique_array.map(v=>v[3]).indexOf(pre_array[i][3]) < 0) unique_array.push(pre_array[i])
    }

     */

    //pre_array = pre_array.filter(v=>v[6]!=-1)

    array = array.concat( unique_array.filter(v=>String(v[4])==String(station_name+" 도착")) )

    array = array.concat( unique_array.filter(v=>String(v[4])==String(station_name+" 진입")) )

    array = array.concat( unique_array.filter(v=>String(v[4])==String("전역 출발")) )

    array = array.concat( unique_array.filter(v=>String(v[4])==String("전역 도착")) )

    array = array.concat( unique_array.filter(v=>String(v[4])==String("전역 진입")) )

    for (let i=0 ; i<totalCount ; i++){
        try{
            let temp = Number( String(unique_array[i][4]).split("]번째")[0].split("[")[1] ) * 150
            if(isNaN(temp)==false){ unique_array[i][4] = temp }
        }catch(e){}

    }

    for (let i=0 ; i<totalCount ; i++){
        try{
            let temp = Number( String(unique_array[i][4]).split("분")[0] ) * 60
                + Number( String(unique_array[i][4]).split("초")[0].split("분 ")[1] )
            if(isNaN(temp)==false){ unique_array[i][4] = temp }
        }catch(e){}
    }

    unique_array = unique_array.filter(v=>isNaN(v[4])==false)

    array = array.concat( unique_array.sort(function(a,b){return Number(a[4])<Number(b[4]) ? -1 : Number(a[4]) > Number(b[4]) ? 1 : 0}) )

    return array.join("\n\n")

}

Metro.output = function output(room,station){

    let data = Metro.parse(station)

    if(data.length>5){ data.splice(5,data.length-5) }

    let header_title = station+" 검색 결과"
    let title = []
    let sub_title = []
    for(let i=0 ; i<5 ; i++){
        try{
            title[i] = "현재 위치 : " + data[i][4] + " (" + data[i][6] + "행) (" + data[i][10] + ")" // 현재 위치 : 선릉 (서울대입구행) (5분 4초후)
            sub_title[i] = data[i][1] + " " + data[i][2] // 1호선 하행
        }
        catch(e){
            title[i] = ""
            sub_title[i] = ""
        }
    }

    let path = ["","","","",""]
    let THU = ["","","","",""]

    Metro.sendKaling_5list(room, header_title, title, sub_title, path, THU)


}

//====================================== 카링 ======================================



const kalingModule=require("kaling.js").Kakao();

Metro.kakaoReset = function kakaoReset(){
    Kakao = new kalingModule();
    //Kakao.init("29fbf6ec828f27d72544c39a3bb4f8d0"); // P.kakaoint자리(이전)
    Kakao.init("904c559bc0ec53c94df6dad990b24c52"); //
    //Kakao.init("e02397085dc52168fe675d7013e1cfbf"); // P.kakaoint자리

    Kakao.login(Metro.getDB("kakaoId"), Metro.getDB("kakaoPw"));
}

Metro.sendKaling_5list = function sendKaling_5list(room, header_title, title, sub_title, path, THU){


    let kalingObj = {
        "link_ver":"4.0",
        "template_id" : (33106),
        "template_args" : {
            header_title : String(header_title),
            title1 : String(title[0]),
            title2 : String(title[1]),
            title3 : String(title[2]),
            title4 : String(title[3]),
            title5 : String(title[4]),
            path1 : String(path[0]),
            path2 : String(path[1]),
            path3 : String(path[2]),
            path4 : String(path[3]),
            path5 : String(path[4]),
            sub_title1 : String(sub_title[0]),
            sub_title2 : String(sub_title[1]),
            sub_title3 : String(sub_title[2]),
            sub_title4 : String(sub_title[3]),
            sub_title5 : String(sub_title[4]),
            THU1 : String(THU[0]),
            THU2 : String(THU[1]),
            THU3 : String(THU[2]),
            THU4 : String(THU[3]),
            THU5 : String(THU[4])
        }
    }
    try{
        Kakao.send(room, kalingObj, "custom");
    }catch(e){
        UOSP.kakaoReset();
        Kakao.send(room, kalingObj, "custom");
    }
}

Metro.sendKaling_4list = function sendKaling_4list(room, header_title, title, sub_title, path, THU){


    let kalingObj = {
        "link_ver":"4.0",
        "template_id" : (33109),
        "template_args" : {
            header_title : String(header_title),
            title1 : String(title[0]),
            title2 : String(title[1]),
            title3 : String(title[2]),
            title4 : String(title[3]),
            path1 : String(path[0]),
            path2 : String(path[1]),
            path3 : String(path[2]),
            path4 : String(path[3]),
            sub_title1 : String(sub_title[0]),
            sub_title2 : String(sub_title[1]),
            sub_title3 : String(sub_title[2]),
            sub_title4 : String(sub_title[3]),
            THU1 : String(THU[0]),
            THU2 : String(THU[1]),
            THU3 : String(THU[2]),
            THU4 : String(THU[3])
        }
    }
    try{
        Kakao.send(room, kalingObj, "custom");
    }catch(e){
        UOSP.kakaoReset();
        Kakao.send(room, kalingObj, "custom");
    }
}

Metro.sendKaling_3list = function sendKaling_3list(room, header_title, title, sub_title, path, THU){


    let kalingObj = {
        "link_ver":"4.0",
        "template_id" : (33111),
        "template_args" : {
            header_title : String(header_title),
            title1 : String(title[0]),
            title2 : String(title[1]),
            title3 : String(title[2]),
            path1 : String(path[0]),
            path2 : String(path[1]),
            path3 : String(path[2]),
            sub_title1 : String(sub_title[0]),
            sub_title2 : String(sub_title[1]),
            sub_title3 : String(sub_title[2]),
            THU1 : String(THU[0]),
            THU2 : String(THU[1]),
            THU3 : String(THU[2])
        }
    }
    try{
        Kakao.send(room, kalingObj, "custom");
    }catch(e){
        UOSP.kakaoReset();
        Kakao.send(room, kalingObj, "custom");
    }
}

Metro.sendKaling_2list = function sendKaling_2list(room, header_title, title, sub_title, path, THU){


    let kalingObj = {
        "link_ver":"4.0",
        "template_id" : (33112),
        "template_args" : {
            header_title : String(header_title),
            title1 : String(title[0]),
            title2 : String(title[1]),
            path1 : String(path[0]),
            path2 : String(path[1]),
            sub_title1 : String(sub_title[0]),
            sub_title2 : String(sub_title[1]),
            THU1 : String(THU[0]),
            THU2 : String(THU[1])
        }
    }
    try{
        Kakao.send(room, kalingObj, "custom");
    }catch(e){
        UOSP.kakaoReset();
        Kakao.send(room, kalingObj, "custom");
    }
}

Metro.sendKaling_1list = function sendKaling_1list(room, header_title, title, sub_title, path, THU){

    let kalingObj = {
        "link_ver":"4.0",
        "template_id" : (33113),
        "template_args" : {
            header_title : String(header_title),
            title1 : String(title[0]),
            path1 : String(path[0]),
            sub_title1 : String(sub_title[0]),
            THU1 : String(THU[0])
        }
    }
    try{
        Kakao.send(room, kalingObj, "custom");
    }catch(e){
        UOSP.kakaoReset();
        Kakao.send(room, kalingObj, "custom");
    }
}

//========================================= 카링 끝 =========================================

// 테이블 생성 : myDB.execSQL("create table UOSPTable (k text PRIMARY KEY, v text);");

Metro.setDB = function setDB(key,value){
    if(D.selectForArray("UOSPTable", null, "k like ?", key).length == 0){ // 해당하는 key에 value가 없는 경우
        D.insert("UOSPTable",{k:key, v:value})
    }
    else{ // 해당하는 key에 value가 있는 경우
        D.update("UOSPTable", {v:value}, "k=?", [key])
    }
}


Metro.getDB = function getDB(key){
    var arr = D.selectForArray("UOSPTable", null, "k=?", [key]);
    if (arr.length > 0) {
        return arr[0][1];
    } else {
        return undefined;
    }
}


Metro.getNum = function getNum(key) {
    var value = UOSP.getDB(key);
    return isNaN(value) ? 0 : Number(UOSP.getDB(key));
}


module.exports = Metro